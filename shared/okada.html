<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>èƒ½ç™»åŠå³¶ãƒãƒƒãƒ—ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼å‚ç…§ï¼‹ç¾åœ¨åœ°è¡¨ç¤ºãƒ»ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100dvh; width: 100%; }
    .leaflet-touch .leaflet-bar a { width: 42px; height: 42px; line-height: 42px; font-size: 16px; }
    .leaflet-top.leaflet-right { z-index: 1100; }
    .leaflet-bottom.leaflet-right { z-index: 1100; }
    .leaflet-control-locate.leaflet-bar a {
      text-align: center; text-decoration: none; display: block;
      font-size: 20px; line-height: 42px;
    }
    .leaflet-control-locate.leaflet-bar a:focus { outline: none; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // --- æ—¢å®šå€¤ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒç„¡ã„ã¨ãç”¨ï¼‰ ---
    // æœ€åˆã®ä½ç½®ã‚’æŒ‡å®šã—ã¦ãã ã•ã„
    const ini = { lat: 37.42540490, lng: 137.08874129, zoom: 13 };
    // 37.42540490591147, 137.08874129225353 ç”ºé‡ç”º
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ä¸Šæ›¸ã: ?y=<lat>&x=<lng>&z=<zoom>
    (function applyUrlCenter() {
      const p = new URLSearchParams(location.search);
      const y = parseFloat(p.get('y'));   // ç·¯åº¦
      const x = parseFloat(p.get('x'));   // çµŒåº¦
      const z = parseInt(p.get('z'), 10); // ã‚ºãƒ¼ãƒ 
      if (Number.isFinite(y) && y >= -90 && y <= 90 &&
          Number.isFinite(x) && x >= -180 && x <= 180) {
        ini.lat = y; ini.lng = x;
      }
      if (Number.isFinite(z)) ini.zoom = Math.min(19, Math.max(4, z));
    })();

    // ---- åœ°å›³æœ¬ä½“ï¼ˆâ€»åˆæœŸåŒ–ã¯1å›ã ã‘ï¼‰----
    const map = L.map('map', {
      center: [ini.lat, ini.lng],
      zoom: ini.zoom,
      zoomControl: false,
      tap: true,
      tapTolerance: 15
    });

    // ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆï¼‹ï¼âˆ’ï¼‰ã‚’å³ä¸‹ã«
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // ---- Base layers ----
    // åœ°ç†é™¢åœ°å›³ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®š
    const lyrGSI = L.tileLayer(
      "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png", {
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>" 
    }).addTo(map);

    // Google é«˜è§£åƒåº¦ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®š
    const lyrGoogleHybrid = L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}");

     // åœ°éœ‡å‰CSç«‹ä½“å›³ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®š
    const bfCS = L.tileLayer("https://www2.ffpri.go.jp/soilmap/tile/cs_noto/{z}/{x}/{y}.png");

     // åœ°éœ‡å¾ŒCSç«‹ä½“å›³ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®š
    const afCS = L.tileLayer("https://rinya.geospatial.jp/tile/csmaptile_noto/{z}/{x}/{y}.png");


    // ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å®šç¾©
    const baseMaps = {
      "åœ°ç†é™¢åœ°å›³": lyrGSI,
      "Googleé«˜è§£åƒåº¦ï¼ˆåœ°éœ‡å‰ï¼‰": lyrGoogleHybrid,
      "åœ°éœ‡å‰CSç«‹ä½“å›³":bfCS,
      "åœ°éœ‡å¾ŒCSç«‹ä½“å›³":afCS,
    };

    // ==== ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆé‡ã­ã‚‹ã¨è¡¨ç¾ãŒå¤‰ã‚ã£ã¦é¢ç™½ã„ï¼‰ ====
    // é™°å½±èµ·ä¼å›³ï¼ˆåœ°å½¢ã®é™°å½±ï¼‰
    const gsiHillshade = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png', {
      maxZoom: 16, opacity: 0.7, attribution: 'åœ°ç†é™¢ã‚¿ã‚¤ãƒ«ï¼ˆé™°å½±èµ·ä¼å›³ï¼‰'
    });

    
    // ==== ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆé‡ã­ã‚‹ã¨è¡¨ç¾ãŒå¤‰ã‚ã£ã¦é¢ç™½ã„ï¼‰ ====
    // 1960å¹´ä»£ã®å†™çœŸ
    const ort1960th = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/ort_old10/{z}/{x}/{y}.png', {
      maxZoom: 16, opacity: 1, attribution: 'åœ°ç†é™¢ã‚¿ã‚¤ãƒ«ï¼ˆ1960å¹´ä»£å†™çœŸï¼‰'
    });

    // ==== ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆé‡ã­ã‚‹ã¨è¡¨ç¾ãŒå¤‰ã‚ã£ã¦é¢ç™½ã„ï¼‰ ====
    // åœ°éœ‡å¾ŒALTå†™çœŸ
    const ort2024th = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/20240102noto_0405_0426do/{z}/{x}/{y}.png ', {
      maxZoom: 16, opacity: 1, attribution: 'åœ°ç†é™¢ã‚¿ã‚¤ãƒ«ï¼ˆåœ°éœ‡å¾Œç©ºä¸­å†™çœŸï¼‰'
    });

    // ==== ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆé‡ã­ã‚‹ã¨è¡¨ç¾ãŒå¤‰ã‚ã£ã¦é¢ç™½ã„ï¼‰ ====
    // åœ°å½¢å¤‰åŒ–é‡ãƒ‡ãƒ¼ã‚¿
    const geol = L.tileLayer('https://gbank.gsj.jp/geonavi/maptile/wmts/1.0.0/G50_10_003004006007suzumisaki-notoiida/default/EPSG900913/{z}/{y}/{x}.png', {
      maxZoom: 16, opacity: 0.6, attribution: 'ç”£ç·ç ”5ä¸‡åˆ†ã®1åœ°è³ªå›³'
    });

    // æ³¨è¨˜ï¼ˆåœ°åãƒ©ãƒ™ãƒ«ï¼‰â€” èˆªç©ºå†™çœŸã‚„è‰²åˆ¥æ¨™é«˜å›³ã®ä¸Šã«é‡ã­ã‚‹ã¨ä¾¿åˆ©
    const gsiLabel = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/label/{z}/{x}/{y}.png', {
      maxZoom: 18, opacity: 0.9, attribution: 'åœ°ç†é™¢ã‚¿ã‚¤ãƒ«ï¼ˆæ³¨è¨˜ï¼‰'
    });

    // èƒ½ç™»åŠå³¶ãƒ»é–€å‰åœ°åŒºã®å‚¾æ–œã‚¿ã‚¤ãƒ«ï¼ˆè‡ªä½œ XYZï¼‰
    const slopeTile = L.tileLayer('./tilemaps/slope/{z}/{x}/{y}.png', {
      minZoom: 12,
      maxZoom: 16,
      opacity: 0.8,
      attribution: 'è‡ªä½œå‚¾æ–œã‚¿ã‚¤ãƒ«'
    });

    // ---- Overlaysï¼ˆç©ºã® GeoJSON ãƒ¬ã‚¤ãƒ¤ã‚’ç”¨æ„ï¼‰----
    const jsonHoukai = L.geoJSON(null, {
      pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
        radius: 5, weight: 1, color: '#b22222', fillColor: '#ff6666', fillOpacity: 0.7
      }),
      style: () => ({ color: '#b22222', weight: 2, fillOpacity: 0.3 }),
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        const html = [
          p.name ? `<div><strong>${p.name}</strong></div>` : '',
          p.type ? `<div>ç¨®åˆ¥: ${p.type}</div>` : '',
          p.date ? `<div>æ—¥ä»˜: ${p.date}</div>` : ''
        ].join('');
        if (html) layer.bindPopup(html);
      }
    });

    const jsonJisuberi = L.geoJSON(null, {
      pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
        radius: 5, weight: 1, color: '#ff7f50', fillColor: '#ff7f50', fillOpacity: 0.7
      }),
      style: () => ({ color: '#ff7f50', weight: 2, fillOpacity: 0.3 }),
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        const html = [
          p.name ? `<div><strong>${p.name}</strong></div>` : '',
          p.type ? `<div>ç¨®åˆ¥: ${p.type}</div>` : '',
          p.date ? `<div>æ—¥ä»˜: ${p.date}</div>` : ''
        ].join('');
        if (html) layer.bindPopup(html);
      }
    });

    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å®šç¾©
    const overlays = {
      "é™°å½±èµ·ä¼å›³ï¼ˆé‡ã­ãŒã‘ï¼‰": gsiHillshade,
      "åœ°éœ‡å¾Œå´©å£Š": jsonHoukai,
      "åœ°éœ‡å¾Œåœ°ã™ã¹ã‚Š": jsonJisuberi,
      "1960å¹´ä»£å†™çœŸ": ort1960th,
      "åœ°éœ‡å¾Œç©ºä¸­å†™çœŸ":ort2024th,
      "ç”£ç·ç ”5ä¸‡åˆ†ã®1åœ°è³ªå›³":geol,
      "æ³¨è¨˜ï¼ˆåœ°åãƒ©ãƒ™ãƒ«ï¼‰": gsiLabel
    };

    // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ 

    L.control.layers(baseMaps, overlays, { collapsed: true, position: 'topright' }).addTo(map);

    // ---- GeoJSON ã®èª­ã¿è¾¼ã¿ ----
    // â€» åˆæœŸè¡¨ç¤ºã‹ã‚‰ONã«ã—ãŸã„å ´åˆã¯ã€èª­ã¿è¾¼ã¿å¾Œã« addTo(map) ã™ã‚‹
    //    ã•ã‚‰ã«å…¨ä½“ã¸å¯„ã›ãŸã„å ´åˆã¯ fitBounds ã™ã‚‹
    Promise.all([
      fetch('./src/geojson/houkai_machino.geojson').then(r => r.json()).then(g => { jsonHoukai.addData(g); }),
      fetch('./src/geojson/jisuberi_machino.geojson').then(r => r.json()).then(g => { jsonJisuberi.addData(g); }),
    ]).then(() => {
    }).catch(err => {
      console.error('GeoJSON èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
    });

    // ======== ç¾åœ¨åœ°è¡¨ç¤ºï¼ˆGPSï¼‰æ©Ÿèƒ½ ========
    let locateMarker = null, locateCircle = null;
    function showLocation(lat, lng, accuracy) {
      const latlng = [lat, lng];
      if (!locateMarker) locateMarker = L.marker(latlng, { title: "ç¾åœ¨åœ°" }).addTo(map);
      else locateMarker.setLatLng(latlng);

      if (!locateCircle) locateCircle = L.circle(latlng, { radius: accuracy || 30, color: '#136aec', fillColor: '#136aec', fillOpacity: 0.15, weight: 2 }).addTo(map);
      else { locateCircle.setLatLng(latlng); if (accuracy) locateCircle.setRadius(accuracy); }

      map.setView(latlng, Math.max(map.getZoom(), 15), { animate: true });
    }
    function locateOnce() {
      if (!navigator.geolocation) { alert("ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚"); return; }
      navigator.geolocation.getCurrentPosition(
        pos => showLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy),
        err => {
          console.warn("Geolocation error:", err);
          alert("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/ç’°å¢ƒã‚’ã”ç¢ºèªãã ã•ã„ï¼‰ã€‚");
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }
    const LocateControl = L.Control.extend({
      options: { position: 'bottomright' },
      onAdd: function() {
        const container = L.DomUtil.create('div', 'leaflet-control-locate leaflet-bar');
        const link = L.DomUtil.create('a', '', container);
        link.href = '#'; link.title = 'ç¾åœ¨åœ°ã¸ç§»å‹•'; link.setAttribute('role', 'button'); link.setAttribute('aria-label', 'ç¾åœ¨åœ°ã¸ç§»å‹•'); link.innerHTML = 'ğŸ“';
        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.on(link, 'click', (e) => { L.DomEvent.preventDefault(e); locateOnce(); });
        return container;
      }
    });
    map.addControl(new LocateControl());

    addEventListener('orientationchange', () => setTimeout(() => map.invalidateSize(), 250));
    addEventListener('resize', () => setTimeout(() => map.invalidateSize(), 250));

    // ãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    // ã“ã“ã‹ã‚‰ã‚’è¿½åŠ 
var myPoints = {
    "type": "FeatureCollection",
    "features": [
      {
        "type": "Feature",
        "properties": {
          "popupContent": "<p>å¤§ä¹…ä¿</p>"
        },
        "geometry": {
          "type": "Point",
          "coordinates": [137.1240283381606,37.45775974580575]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "popupContent": "<p>å·è¥¿</p>"
        },
        "geometry": {
          "type": "Point",
          "coordinates": [137.0691591512637,37.41872044671268]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "popupContent": "<p>ç‰›å°¾</p>"
        },
        "geometry": {
          "type": "Point",
          "coordinates": [137.11193291227522,37.44970194255018]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "popupContent": "<p>éˆ´å±‹å´©å£Š</p>"
        },
        "geometry": {
          "type": "Point",
          "coordinates": [137.10635,37.42762]
        }
      },
      


    ]
  };
  
  L.geoJSON(myPoints, 
    {
      onEachFeature: function onEachFeature(
        feature,
        layer
      ){
        if(feature.properties && feature.properties.popupContent){
          layer.bindPopup(feature.properties.popupContent);
        }
      }
    }
  ).addTo(map);
    // ãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    // ã“ã“ã¾ã§ã‚’è¿½åŠ 
</script>
</body>
</html>
